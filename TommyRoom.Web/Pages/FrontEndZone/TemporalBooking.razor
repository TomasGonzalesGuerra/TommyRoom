@page "/TemporalBooking"
@implements IDisposable
@inject ISnackbar _snackbar
@inject IRepository _repository
@inject ICartService _cartService
@inject IDialogService _dialogService
@inject SweetAlertService _sweetAlertService
@inject NavigationManager _navigationManager
@inject ReservationNotificationState _reservationState

<PageTitle>Temporal Booking</PageTitle>

@if (cartItemDTOs == null)
{
    <MudStack Class="pa-4">
        <MudText Typo="Typo.h1" Color="Color.Error"> Objeto Nulo </MudText>
    </MudStack>
}
else if (cartItemDTOs.Count() == 0)
{
    <MudStack Class="pa-4">
        <MudImage Src="https://cdn-icons-png.flaticon.com/512/12044/12044970.png" Style="width: auto; height: 50vh; object-fit: cover;" />
        <MudText Typo="Typo.h6" Color="Color.Error"> Sin Registros </MudText>
    </MudStack>
}
else
{
    <MudTable Items="@bookingDTOs" Bordered="true" Hover="true" FixedHeader="true" Loading="@_loading" LoadingProgressColor="Color.Info" Style="width: 75%;">
        <ToolBarContent><MudText Typo="Typo.h4">Tus Reservas</MudText></ToolBarContent>

        <HeaderContent>
            <MudTh>Habitación</MudTh>
            <MudTh>Detalle</MudTh>
            <MudTh>Inicio de Reserva</MudTh>
            <MudTh>Fin de Reserva</MudTh>
            <MudTh>Eliminar</MudTh>
        </HeaderContent>

        <RowTemplate>
            <MudTd DataLabel="Habitación">
                <MudStack>
                    <MudAvatar Size="Size.Large"><MudImage Src="@context.Photo"></MudImage></MudAvatar>
                    <MudText Typo="Typo.caption" Color="Color.Inherit"> @context.Name </MudText>
                </MudStack>
            </MudTd>

            <MudTd DataLabel="Detalle">
                <MudText Typo="Typo.caption" Color="Color.Inherit"> @context.Description </MudText>
                <MudText Typo="Typo.caption" Color="Color.Inherit"> @context.Capacity </MudText>
                <MudText Typo="Typo.caption" Color="Color.Inherit"> @($"{context.PricePerNight}/día") </MudText>
            </MudTd>

            <MudTd DataLabel="Inicio de Reserva">
                <MudDatePicker @bind-Date="@context.StartTime"
                            Label="Inicio de Reserva"
                            DateFormat="dd/MM/yyyy"
                            Required="true"
                            RequiredError="El StartTime es Obligatorio!" />
            </MudTd>

            <MudTd DataLabel="Fin de Reserva">
                <MudDatePicker @bind-Date="@context.EndTime"
                               Label="Fin de Reserva"
                               DateFormat="dd/MM/yyyy"
                               Required="true"
                               RequiredError="El EndTime es Obligatorio!" />
            </MudTd>

            <MudTd DataLabel="Eliminar">
                <MudIconButton OnClick="@(() => BookinRoomAsync(context))" Icon="@Icons.Material.Outlined.BookmarkAdded" Color="Color.Success" Size="Size.Medium" />
                <MudIconButton OnClick="@(() => DeleteItemAsync(context.RoomId))" Icon="@Icons.Material.Outlined.Delete" Color="Color.Error" Size="Size.Medium" />
            </MudTd>
        </RowTemplate>

        <PagerContent>
            <MudTablePager PageSizeOptions="new int[] { 5, 10, 15 }" />
        </PagerContent>
    </MudTable>
}


@code {
    private List<CartItemDTO> cartItemDTOs = [];
    private List<TemporalBookingDTO> bookingDTOs = [];
    private bool _loading = true;


    protected override async Task OnInitializedAsync()
    {
        _cartService.OnChangeAsync += LoadCartBookingsAsync;
        await LoadCartBookingsAsync();
    }

    private async Task LoadCartBookingsAsync()
    {
        cartItemDTOs = await _cartService.LoadAsync() ?? [];

        if (cartItemDTOs != null)
        {
            bookingDTOs.Clear();
            foreach (var item in cartItemDTOs)
            {
                bookingDTOs.Add(new()
                {
                    RoomId = item.RoomId,
                    Name = item.Name,
                    Description = item.Description,
                    Capacity = item.Capacity,
                    PricePerNight = item.PricePerNight,
                    Photo = item.Photo,
                    StartTime = DateTime.Now.ToLocalTime(),
                    EndTime = DateTime.Now.ToLocalTime()
                });
            }
        }

        await InvokeAsync(StateHasChanged);
        _loading = false;
    }

    private async Task BookinRoomAsync(TemporalBookingDTO temporalDTO)
    {
        CreatedBookingDTO bookingDTO = new()
        {
            RoomId = temporalDTO.RoomId,
            StartTime = temporalDTO.StartTime,
            EndTime = temporalDTO.EndTime
        };

        var httpResponse = await _repository.PostAsync("api/Bookings", bookingDTO);

        if (httpResponse.Error)
        {
            var message = await httpResponse.GetErrorMessageAsync();
            await _sweetAlertService.FireAsync("Error", message, SweetAlertIcon.Error);
            return;
        }

        await DeleteItemAsync(temporalDTO.RoomId);
        _reservationState.Notify(bookingDTO);
        _snackbar.Add("La RESERVA está Hecha", Severity.Success);
    }

    private async Task DeleteItemAsync(int roomId)
    {
        try
        {
            await _cartService.RemoveItemAsync(roomId!);
        }
        catch (Exception ex)
        {
            await _sweetAlertService.FireAsync("Error", ex.Message, SweetAlertIcon.Error);
        }

        await LoadCartBookingsAsync();
    }

    public void Dispose() => _cartService.OnChangeAsync -= LoadCartBookingsAsync;
}
